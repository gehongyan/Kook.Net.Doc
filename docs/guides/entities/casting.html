<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>&#31867;&#22411;&#36716;&#25442; | Kook.Net &#25991;&#26723; </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="&#31867;&#22411;&#36716;&#25442; | Kook.Net &#25991;&#26723; ">
    <meta name="generator" content="docfx 2.56.7.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="Kook.Net &#25991;&#26723;">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="Guides.Entities.Casting">
<h1 id="类型转换">类型转换</h1>

<p>通过类型转换，实体可以转换为其它定义下的实体，但这种转换仅能在有继承关系的变体间进行。
例如：<code>IUser</code> 可以转换为 <code>IGuildUser</code>，但不能转换为 <code>IMessage</code>。</p>
<div class="NOTE"><h5>Note</h5><p>如果两个接口之间存在继承关系，它们便可以进行互相的转换。
将实体类转换为其所实现的接口也可以合法的。</p>
</div>
<h2 id="向上类型转换">向上类型转换</h2>
<p>通过向上类型转换，实体可以被转换为更通用的变体，例如：将 <code>IGuildUser</code> 转换为 <code>IUser</code>。
尽管向上类型转换的结果往往具有更简化的信息，但由于多态性，基类类型的变量可以保存派生类型。
向上类型转换一般是隐式进行的。</p>
<p>通过向下类型转换，实体可以转换为包含更详细信息的变体，例如：将 <code>IUser</code> 转换为 <code>IGuildUser</code>，
这样便可以访问原始无法直接访问的信息。</p>
<h2 id="向下类型转换">向下类型转换</h2>
<p>向下类型转换是访问实体的实际定义最直接的方式，如果要访问派生类型的实例成员，
可以直接进行向下类型转换。向下类型转换一般是显式进行的。</p>
<pre><code class="lang-csharp" name="Up-casting and Down-casting">IUser user;

// &#36825;&#37324;&#20351;&#29992;&#20102;&#20869;&#32852;&#30340;&#21521;&#19979;&#31867;&#22411;&#36716;&#25442;&#26469;&#19968;&#27425;&#24615;&#33719;&#21462;&#23383;&#27573;&#25968;&#25454;
// &#38656;&#35201;&#27880;&#24847;&#30340;&#26159;&#65292;&#22914;&#26524;&#31867;&#22411;&#36716;&#25442;&#30340;&#32467;&#26524;&#23454;&#20307;&#20026; null&#65292;&#21017;&#20250;&#25243;&#20986; NullReferenceException &#24322;&#24120;
Console.WriteLine(((IGuildUser)user).Nickname);

// &#22914;&#26524;&#21487;&#20197;&#20445;&#35777;&#36716;&#25442;&#26159;&#21512;&#27861;&#19988;&#32467;&#26524;&#38750;&#31354;&#30340;&#65292;&#21017;&#21487;&#20197;&#20026;&#31867;&#22411;&#36716;&#25442;&#32467;&#26524;&#36171;&#20540;&#21040;&#21478;&#19968;&#20010;&#21464;&#37327;&#20013;
IGuildUser guildUser = (IGuildUser)user;
</code></pre><div class="WARNING"><h5>Warning</h5><p>作为一种强制类型转换操作，如果两种类型之间不兼容，向下类型转换可能会在执行时抛出
<code>InvalidCastException</code> 异常，在这种情况下，通过模式匹配来进行类型转换可以有效地避免这种异常。</p>
</div>
<h2 id="更一般的类型转换">更一般的类型转换</h2>
<p>更一般情况下的类型转换往往使用 <code>as</code> 运算符来向将对象转换为给定的类型。
如果实体确实能被转换为给定的类型，运算结果会返回转换后的类型，来让属性可以为访问。</p>
<pre><code class="lang-csharp" name="Casting">IChannel channel;

// &#22914;&#26524;&#35201;&#23558;&#36890;&#29992;&#39057;&#36947;&#25509;&#21475; IChannel &#36716;&#25442;&#20026;&#26381;&#21153;&#22120;&#25991;&#23383;&#39057;&#36947;&#25509;&#21475; ITextChannel
// &#26469;&#35775;&#38382; ITextChannel &#20013;&#23384;&#22312;&#32780; IChannel &#20013;&#19981;&#23384;&#22312;&#30340;&#23646;&#24615;&#21644;&#26041;&#27861;
// &#21017;&#21487;&#36827;&#34892;&#22914;&#19979;&#30340;&#36716;&#25442;
ITextChannel textChannel = channel as ITextChannel;

await textChannel.DoSomethingICantWithIChannelAsync();
</code></pre><div class="WARNING"><h5>Warning</h5><p>如果类型转换的结果可能为 null，在访问其属性或方法时则会抛出 <code>NullReferenceException</code> 异常，
在这种情况下，通过模式匹配进行安全类型转换则更为实用，这可以阻止此异常的抛出。</p>
</div>
<h2 id="安全类型转换">安全类型转换</h2>
<p>安全类型转换在转换前会进行模式匹配检查，因此可以保证转换结果类型永不为 null。</p>
<p>C# 提供了三种语法来进行安全类型转换：</p>
<h3 id="类型检查">类型检查</h3>
<p>要进行安全类型转换，需要使用 <code>is</code> 运算符来检查值是否属于给定地类型。
如果检查不通过，条件判断语句可以绕过代码，来保证程序不会访问 null 对象的属性。</p>
<pre><code class="lang-csharp" name="Casting Check">IUser user;

// &#36825;&#37324;&#26816;&#26597;&#20102;&#35813;&#29992;&#25143;&#23454;&#20307;&#26159;&#21542;&#20026;&#19968;&#20010; IGuildUser &#23454;&#20307;
// &#22914;&#26524;&#26816;&#26597;&#19981;&#36890;&#36807;&#65292;&#26465;&#20214;&#21028;&#26029;&#35821;&#21477;&#21487;&#20197;&#32469;&#36807;&#21487;&#33021;&#20250;&#23548;&#33268; null &#23545;&#35937;&#35775;&#38382;&#30340;&#20195;&#30721;
if (user is IGuildUser)
{
    Console.WriteLine(&quot;This user is in a guild!&quot;);
}
else
{
    // &#26816;&#26597;&#19981;&#36890;&#36807;
}
</code></pre><h3 id="结合声明的初始化赋值">结合声明的初始化赋值</h3>
<p>这里，类型检查、类型声明、初始化赋值组合在一起，可以简化代码，
这样，在类型检查通过后，对象将会被立即转换并赋值到一个新的变量中。</p>
<pre><code class="lang-csharp" name="Casting Declaration">IUser user;

// &#20551;&#35774;&#36825;&#37324;&#30340; user &#21464;&#37327;&#20869;&#20107;&#23454;&#19978;&#23384;&#20648;&#30340;&#26159;&#19968;&#20010; IGuildUser &#23545;&#35937;
// &#37027;&#20040;&#22312;&#31867;&#22411;&#26816;&#26597;&#36890;&#36807;&#21518;&#65292;&#27492;&#22788;&#30340;&#20195;&#30721;&#21487;&#20197;&#30452;&#25509;&#23558; user &#36716;&#25442;&#20026; IGuildUser
// &#24182;&#36171;&#20540;&#21040; guildUser &#21464;&#37327;&#20013;
// &#36825;&#26679;&#23601;&#19981;&#29992;&#20877;&#22312;&#21518;&#38754;&#30340;&#20195;&#30721;&#20013;&#20877;&#27425;&#36827;&#34892;&#31867;&#22411;&#36716;&#25442;&#20102;
if (user is IGuildUser guildUser)
{
    Console.WriteLine(guildUser.JoinedAt);
}
else
{
    // &#26816;&#26597;&#19981;&#36890;&#36807;
}
</code></pre><h3 id="结合逻辑模式">结合逻辑模式</h3>
<p>在之前的示例中，我们通过类型检查来避免程序在进行不正确的类型转换后抛出异常，
在此实例中，代码会在类型转换检查不通过时忽略后续代码来结束整个方法返回结果，
如类型转换成功，其所一并声明的变量也可以在后续的代码中被使用。</p>
<pre><code class="lang-csharp" name="Casting Inverse Check">private void MyFunction(IMessage message)
{
    // &#36825;&#37324;&#30340;&#31867;&#22411;&#26816;&#26597;&#19982;&#36923;&#36753;&#27169;&#24335;&#20013;&#30340; not &#30456;&#32467;&#21512;
    // &#24403; message &#19981;&#20026; IUserMessage &#26102;&#65292;&#26041;&#27861;&#20250;&#30452;&#25509;&#36820;&#22238;
    if (message is not IUserMessage userMessage)
        return;

    // &#30001;&#20110;&#20197;&#19978;&#20195;&#30721;&#36827;&#34892;&#30340;&#31867;&#22411;&#26816;&#26597;&#26159;&#20869;&#32852;&#30340;
    // &#31867;&#22411;&#36716;&#25442;&#32467;&#26524; userMessage &#21464;&#37327;&#22312;&#21028;&#26029;&#35821;&#21477;&#22806;&#20063;&#21487;&#20197;&#35775;&#38382;
    Console.WriteLine(userMessage.Author);
}
</code></pre><div class="NOTE"><h5>Note</h5><p>在类型转换或类型检查时需使用 <code>is</code>、<code>as</code> 和 <code>not</code> 关键字。
<code>==</code>、<code>!=</code> 和 <code>=</code> 适用于变量或实例化对象之间，而非它们与类型之间，
如要获取变量或实例化对象的类型，请使用 <code>Object.GetType</code> 方法或 <code>typeof</code> 运算符。</p>
</div>
</article>
          </div>
          <div class="contribution-panel mobile-hide">
              <a href="https://github.com/gehongyan/Kook.Net/blob/master/docs/guides/entities/casting.md/#L1" title="Improve this Doc" class="fab btn-warning pull-right"><i class="glyphicon glyphicon-pencil"></i></a>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            Kook.Net (c) 2022-2023
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
