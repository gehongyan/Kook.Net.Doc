<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
    
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>&#20174;&#38646;&#24320;&#22987; | KaiHeiLa.Net &#25991;&#26723; </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="&#20174;&#38646;&#24320;&#22987; | KaiHeiLa.Net &#25991;&#26723; ">
      <meta name="generator" content="docfx 2.56.7.0">
      
      <link rel="shortcut icon" href="../../favicon.ico">
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/night-owl.min.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" integrity="sha384-EvBWSlnoFgZlXJvpzS+MAUEjvN7+gcCwH+qh7GRFOGgZO0PuwOFro7qPOJnLfe7l" crossorigin="anonymous">
      <link rel="stylesheet" href="../../styles/config.css">
      <link rel="stylesheet" href="../../styles/discord.css">
      <link rel="stylesheet" href="../../styles/singulink.css">
      <link rel="stylesheet" href="../../styles/main.css">
      <meta property="docfx:navrel" content="../../toc.html">
      <meta property="docfx:tocrel" content="../toc.html">
      
      <meta property="docfx:rel" content="../../">
      
    </head>
    <body>
        <div class="top-navbar">
            <a class="burger-icon" onclick="toggleMenu()">
                <svg name="Hamburger" style="vertical-align: middle;" width="34" height="34" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M20 6H4V9H20V6ZM4 10.999H20V13.999H4V10.999ZM4 15.999H20V18.999H4V15.999Z"></path></svg>
            </a>

            
            <a class="brand" href="../../index.html">
              <img src="../../logo.svg" alt="KaiHeiLa.Net &#25991;&#26723;" class="logomark">
              <span class="brand-title">KaiHeiLa.Net &#25991;&#26723;</span>
            </a>        </div>

        <div class="body-content">
            <div id="blackout" class="blackout" onclick="toggleMenu()"></div>

            <nav id="sidebar" role="navigation">
                <div class="sidebar">
                    
                    <div>
                      <div class="mobile-hide">
                        
                        <a class="brand" href="../../index.html">
                          <img src="../../logo.svg" alt="KaiHeiLa.Net &#25991;&#26723;" class="logomark">
                          <span class="brand-title">KaiHeiLa.Net &#25991;&#26723;</span>
                        </a>  </div>

                      <div class="sidesearch">
                        <form id="search" role="search" class="search">
                            <i class="bi bi-search search-icon"></i>
                            <input type="text" id="search-query" placeholder="Search" autocomplete="off">
                        </form>
                      </div>
                    
                      <div id="navbar">
                      </div>
                    </div>                    <div class="sidebar-item-separator"></div>
                        
                        <div id="sidetoggle">
                          <div id="sidetoc"></div>
                        </div>
                </div>
                <div class="footer">
                  KaiHeiLa.Net (c) 2022
                  
                </div>            </nav>

            <main class="main-panel">
                
                <div id="search-results" style="display: none;">
                  <h1 class="search-list">Search Results for <span></span></h1>
                  <div class="sr-items">
                    <p><i class="bi bi-hourglass-split index-loading"></i></p>
                  </div>
                  <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
                </div>
                <div role="main" class="hide-when-search">
                        
                        <div class="subnav navbar navbar-default">
                          <div class="container hide-when-search" id="breadcrumb">
                            <ul class="breadcrumb">
                              <li></li>
                            </ul>
                          </div>
                        </div>

                    <article class="content wrap" id="_content" data-uid="Guides.GettingStarted.FirstBot">
<h1 id="使用-kaiheilanet-构建你的第一个-bot">使用 KaiHeiLa.Net 构建你的第一个 Bot</h1>

<p>本指南将引导您使用 KaiHeiLa.Net 构建一个简单的 Bot。在此之前，请先确保您已参与开黑啦开发者，并获得开发权限。</p>
<h2 id="创建一个开黑啦应用">创建一个开黑啦应用</h2>
<p>在开始编写代码前，您需要通过开黑啦开发者中心创建一个 Bot。</p>
<ol>
<li>访问并登录到 <a href="https://developer.kaiheila.cn/app/index">开黑啦开发者中心</a>；</li>
<li>点击 <code>新建应用</code>；</li>
<li>填写应用名称；</li>
<li>点击刚刚创建好的应用；</li>
<li><p>点击左侧的 <code>机器人</code>；</p>
<p> <img src="images/intro/intro-bot-entrance.png" alt="img.png"></p>
</li>
<li><p>确保机器人的连接模式为 <code>WebSocket</code>；</p>
<p> <img src="images/intro/intro-bot-websocket.png" alt="img.png"></p>
</li>
<li><p>(可选) 如果要创建公共 Bot，开启 <code>开启公共机器人</code> 开关。</p>
<p> <img src="images/intro/intro-bot-public.png" alt="img.png"></p>
</li>
</ol>
<h2 id="将-bot-添加到服务器">将 Bot 添加到服务器</h2>
<p>Bot 无法通过访问服务器的邀请链接进入频道，因此需要 Bot 的邀请链接将 Bot 添加到服务器。</p>
<ol>
<li>在 <a href="https://developer.kaiheila.cn/bot">开黑啦开发者中心</a> 中访问要添加到服务器的 Bot 应用；</li>
<li><p>点击左侧的 <code>邀请链接</code>；</p>
<p> <img src="images/intro/intro-bot-invite.png" alt="img.png"></p>
</li>
<li><p>在右侧的 <code>角色权限设置</code> 中勾选要在 Bot 进入服务器后直接拥有的权限；</p>
<div class="NOTE"><h5>Note</h5><p>这将会在服务器内创建一个仅可授予给该 Bot 的托管角色，该 Bot 将会在进入服务器后自动获得该角色。
如需在进入服务器后变更权限，可通过 <code>服务器设置</code> 中的 <code>角色权限</code> 进行修改。</p>
</div>
</li>
<li><p>打开上方生成的邀请链接；</p>
</li>
<li>选择要将 Bot 添加到的服务器；</li>
<li><p>点击邀请。</p>
<p> <img src="images/intro/intro-bot-select.png" alt="img.png"></p>
<div class="NOTE"><h5>Note</h5><p>列表中仅显示您拥有 <code>管理服务器</code> 权限的服务器。</p>
</div>
</li>
</ol>
<h2 id="将-bot-连接至开黑啦">将 Bot 连接至开黑啦</h2>
<p>如果您已创建工程，并安装了 KaiHeiLa.Net，可参考以下步骤，
否则，请参考 <a class="xref" href="installing.html">&#23433;&#35013; KaiHeiLa.Net</a> 。</p>
<h3 id="异步启动">异步启动</h3>
<p>KaiHeiLa.Net 广泛采用 .NET 的 <a href="https://docs.microsoft.com/zh-cn/dotnet/csharp/async">异步编程模型</a>，绝大多数操作都是以异步方式完成，
请尽可能地在异步上下文中等待这些操作。</p>
<p>可以通过这样的方式创建异步的入口点函数，来建立一个在异步上下文中启动的程序：</p>
<pre><code class="lang-csharp" name="Async Main">public class Program
{
    public static Task Main(string[] args) =&gt; new Program().MainAsync();

    public async Task MainAsync()
    {
    }
}
</code></pre><div class="WARNING"><h5>Warning</h5><p>应用程序中异步上下文抛出的任何异常都会被持续向上层抛出直到首个同步方法，
由于该程序的首个同步方法是程序的入口点函数 <code>Main</code>，
<strong>所有</strong>未经处理的异常都会被抛出到这里，这将导致程序退出。</p>
<p>KaiHeiLa.Net 会阻止事件处理函数中发生的异常，以避免该异常导致程序退出，
但 <code>MainAsync</code> 中的任何其它未经处理的异常仍然会导致程序退出。</p>
</div>
<h3 id="创建日志方法">创建日志方法</h3>
<p>在创建并配置开黑啦 Bot 客户端程序前，我们需要创建一个事件处理程序来订阅 KaiHeiLa.Net 的日志事件。</p>
<p>为了尽可能地广泛支持各种日志提供程序，KaiHeiLa.Net 通过 <code>Log</code> 事件来记录日志信息，
其事件参数为 <code>LogMessage</code>。有关该事件地详细信息，可参考 <a href="xref:KaiHeila.Rest.BaseKaiHeilaClient.Log">API 文档</a>。</p>
<p>如需要使用自己的日志记录框架，请在此该事件行调用。此处，为了简单起见，我们仅将日志记录到控制台中。</p>
<pre><code class="lang-csharp" name="Simple Logging">private Task Log(LogMessage msg)
{
    Console.WriteLine(msg.ToString());
    return Task.CompletedTask;
}
</code></pre><h3 id="创建开黑啦-bot-客户端程序">创建开黑啦 Bot 客户端程序</h3>
<p>为了编写一个能与开黑啦服务端实时互动的 Bot，请使用 <a class="xref" href="../../api/KaiHeiLa.WebSocket.KaiHeiLaSocketClient.html">KaiHeiLaSocketClient</a> 作为客户端，
使用 Socket 实体，如您不了解 KaiHeiLa.Net 的多种实现，请参考 <a class="xref" href="terminology.html">&#26415;&#35821;</a> 。
在异步入口点中创建一个 <a class="xref" href="../../api/KaiHeiLa.WebSocket.KaiHeiLaSocketClient.html">KaiHeiLaSocketClient</a> 的实例，用于与开黑啦服务端建立连接，
如有需要，也可向构造函数中传递一个 <a class="xref" href="../../api/KaiHeiLa.WebSocket.KaiHeiLaSocketConfig.html">KaiHeiLaSocketConfig</a> 的可选参数，
多数情况下，默认值即可。</p>
<p>在连接前，将刚刚创建的日志事件处理程序订阅到客户端的 <code>Log</code> 事件中。
KaiHeiLa.Net 中的事件与 C# 中的任何其他事件的工作机制类似。</p>
<p>使用 <a class="xref" href="../../api/KaiHeiLa.Rest.BaseKaiHeiLaClient.html#KaiHeiLa_Rest_BaseKaiHeiLaClient_LoginAsync_">LoginAsync</a> 方法登录到开黑啦服务端，登录过程采用的身份认证信息为机器人的 Token。</p>
<p><img src="images/intro/intro-bot-token.png" alt="img.png"></p>
<p>通过调用客户端的 <a href="xref:KaiHeiLa.WebSocket.KaiHeiLaSocketClient.StartAsync*">StartAsync</a> 方法，客户端启动与服务端的连接/重连机制，
<strong>该方法会在连接/重连机制启动后立刻返回</strong>，因此，任何依赖于客户端状态的方法
都应以事件处理程序的形式执行。</p>
<p>为了阻止程序在运行期间的异步入口点返回，请在 <code>MainAsync</code> 方法退出前等待一个无限时长的延迟，
获取其它可以阻止程序继续运行的方法，例如，等待控制台中输入信息。</p>
<div class="IMPORTANT"><h5>Important</h5><p>Token 可允许您获得对 Bot 的所有访问权限，因此，<strong>不要</strong>与任何无关人员共享 Token！
如您要公开 Bot 的源代码，请将该 Token 存储在外部源中。</p>
<p>在下面的示例中，我们从预定义的变量中获取变量，这是<strong>极其不安全</strong>的，
尤其是在有计划将应用程序以任何形式发布的情况下。</p>
<p>为了能够安全地处理该机密信息，建议以 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.environment.getenvironmentvariable?view=net-6.0">环境变量</a>、<a href="https://docs.microsoft.com/zh-cn/dotnet/core/extensions/configuration">配置文件</a>、<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/app-secrets?view=aspnetcore-6.0&amp;tabs=linux">机密管理</a> 等形式存储 Token。</p>
</div>
<pre><code class="lang-csharp" name="Create Client">private KaiHeiLaSocketClient _client;

public async Task MainAsync()
{
    _client = new KaiHeiLaSocketClient();

    _client.Log += Log;

    //  &#23558; Token &#20889;&#20837;&#23383;&#31526;&#20018;&#21464;&#37327;&#65292;&#29992;&#20110; Bot &#30331;&#24405;&#36807;&#31243;&#30340;&#36523;&#20221;&#35748;&#35777;
    //  &#36825;&#24456;&#19981;&#23433;&#20840;&#65292;&#23588;&#20854;&#26159;&#22312;&#26377;&#20844;&#24320;&#28304;&#20195;&#30721;&#30340;&#24773;&#20917;&#19979;&#65292;&#19981;&#24212;&#35813;&#36825;&#20040;&#20570;
    var token = &quot;token&quot;;

    // &#19968;&#20123;&#20854;&#23427;&#23384;&#20648; Token &#30340;&#26041;&#26696;&#65292;&#22914;&#29615;&#22659;&#21464;&#37327;&#12289;&#25991;&#20214;&#31561;
    // var token = Environment.GetEnvironmentVariable(&quot;NameOfYourEnvironmentVariable&quot;);
    // var token = File.ReadAllText(&quot;token.txt&quot;);
    // var token = JsonConvert.DeserializeObject&lt;AConfigurationClass&gt;(File.ReadAllText(&quot;config.json&quot;)).Token;

    await _client.LoginAsync(TokenType.Bot, token);
    await _client.StartAsync();

    // &#38459;&#27490;&#31243;&#24207;&#36864;&#20986;
    await Task.Delay(Timeout.Infinite);
}
</code></pre><p>到这里，客户端应该可以连接到开黑啦服务端，运行程序，等待片刻，应该可以在开黑啦客户端中看到 Bot 上线。</p>
<div class="NOTE"><h5>Note</h5><p>如需查看完整代码示例，可访问 <a href="samples/simple-bot.cs">完整代码示例</a>。</p>
</div>
</article>
                </div>

            </main>
        </div>

        
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
        <script type="text/javascript" src="../../styles/jquery.twbsPagination.js"></script>
        <script type="text/javascript" src="../../styles/url.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
        <script type="text/javascript" src="../../styles/docfx.js"></script>
        <script type="text/javascript" src="../../styles/singulink.js"></script>
        <script type="text/javascript" src="../../styles/main.js"></script>    </body>
</html>
